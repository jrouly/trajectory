"""
trajectory.py
Author: Jean Michel Rouly

This is the main executable file. Use it to call subcommands in the
application structure.
"""


from trajectory import engines, scrape
from argparse import ArgumentParser
import trajectory.log
import sys
import os

# Constant values.
# TODO: These should be read from a configuration at some point.
PROG_NAME = "Trajectory"
PROG_DESC = "This Python application is used to acquire (scrape, clean) a dataset."
PROG_VERSION = PROG_NAME + " 0.0"


def main():
    """
    Handle basic command line argument parsing & configure logging. Route
    logic depending on what the user wants to do.
    """

    # Verify that the TRJ_HOME variable is set.
    if os.environ.get("TRJ_HOME") is None:
        print("TRJ_HOME not found. Exiting.")
        sys.exit( 1 )
    else:
        HOME = os.environ.get("TRJ_HOME")


    # Create top-level command line argument parser.
    parser = ArgumentParser(description=PROG_DESC, prog=PROG_NAME)
    parser.add_argument("--version", action="version", version=PROG_VERSION)
    parser.add_argument("--debug", action="store_true")
    parser.add_argument("--logging-dir", help="Logging directory.",
            default=os.path.join(HOME, "logs"))
    parser.add_argument("--data-dir", help="Data directory.",
            default=os.path.join(HOME, "data"))


    # Create arguments for scraping.
    parser.add_argument("targets", choices=engines.list(),
            nargs="+",
            help="Scraping engines.")
    parser.add_argument("--download",
            help="Download data from the Web.",
            action="store_true")
    parser.add_argument("--digest",
            help="Digest and clean local data.",
            action="store_true")
    parser.add_argument("--purge",
            help="Remove local data.",
            action="store_true")


    # Parse command line arguments.
    args = parser.parse_args(sys.argv[1:])


    # Construct global logging object.
    log = trajectory.log.global_logger("root", debug=args.debug)


    # Start up program.
    log.info("Beginning trj-scrape.")


    # Execute subcommand logic.
    scrape( args )


    # Exit the program.
    log.info("Exiting.")
    sys.exit( 0 )


if __name__ == '__main__':
    main()
