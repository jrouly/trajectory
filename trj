#! /usr/bin/env python

"""
trajectory.py
Author: Jean Michel Rouly

This is the main executable file. Use it to call subcommands in the
application structure.
"""


from argparse import ArgumentParser
from trajectory.clean import CLEAN_TARGETS
import trajectory.log
import sys
import os


# Constant values.
# TODO: These should be read from a configuration at some point.
PROG_NAME = "Trajectory"
PROG_DESC = "Trajectory is ... desc here ... "
PROG_VERSION = PROG_NAME + " 0.0"
SCRAPE_TARGETS = ["gmu.cs"]


def main():
    """
    Handle basic command line argument parsing & configure logging. Route
    logic depending on what the user wants to do.
    """

    # Create top-level command line argument parser.
    parser = ArgumentParser(description=PROG_DESC, prog=PROG_NAME)
    parser.add_argument("--version", action="version", version=PROG_VERSION)
    parser.add_argument("--logging-dir", help="log storage directory",
            default="logs")
    parser.add_argument("--data-dir", help="data storage directory",
            default="data")


    # Specify subcommands using a subparser.
    subparsers = parser.add_subparsers(title="subcommands",
            dest="subparser_name",
            description="valid subcommands to run",
            help="indicate which subcommand to run")


    # Create parser for "scrape" command.
    parser_scrape = subparsers.add_parser("scrape", help="scrape syllabi")
    parser_scrape.add_argument("target", choices=SCRAPE_TARGETS,
            help="target website to scrape")


    # Create parser for "clean" command.
    parser_clean = subparsers.add_parser("clean",
            description="The clean subcommand is used to clean up generated content.",
            help="clean data folders")
    parser_clean.add_argument("target",
            choices=CLEAN_TARGETS,
            default=CLEAN_TARGETS[0],
            nargs="*",
            help="what to clean")


    # Parse command line arguments.
    args = parser.parse_args(sys.argv[1:])


    # Construct global logging object.
    log = trajectory.log.global_logger("root")


    # Start up program.
    log.info("Beginning.")


    # Create data directory, if it doesn't already exist.
    if not os.path.exists( args.data_dir ):
        log.info("\"%s\" does not exist.  Creating..." % args.data_dir)
        os.makedirs( args.data_dir )


    # Execute subcommand logic.
    if args.subparser_name == "scrape":
        pass
    elif args.subparser_name == "clean":
        from trajectory.clean import clean
        clean( args )


    # Exit the program.
    log.info("Exiting.")
    sys.exit( 0 )


if __name__ == '__main__':
    main()
